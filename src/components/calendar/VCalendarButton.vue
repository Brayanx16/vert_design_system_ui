<template>
  <v-pop-up position-content="center center" title="Calendário de eventos">
    <template #event-area>
      <icon-calendar />
    </template>
    <template #popup-body>
      <v-calendar-mini
        :events="events"
        :selected-date="calendarSelectedDate"
        @day-was-clicked="onHandleDayClicked"
      ></v-calendar-mini>

      <div class="search-events">
        <input v-model="search" placeholder="Search" @input="searchEvent" />
      </div>

      <div id="container-list" class="list-events">
        <div v-if="eventsOfDay.length > 0">
          <div
            v-for="(event, index) in eventsOfDay"
            :key="index"
            class="list-events__item"
          >
            <Event :event="event" @click="onHandleEventClicked(event)"></Event>
          </div>
        </div>

        <div v-else class="list-events__empty">
          <p>Nenhum evento encontrado</p>
        </div>
      </div>
    </template>
    <template #popup-footer>
      <a class="a-link">Ir para versão completa</a>
    </template>
  </v-pop-up>
</template>
<script lang="ts" setup>
import { VPopUp, VCalendarMini } from "@/components";
import IconCalendar from "@/components/icons/CalendarDay.vue";
import { IEvent } from "@/utils/types/calendar";
import { onMounted, PropType, ref, watch } from "vue";
import PerfectScrollbar from "perfect-scrollbar";
import Event from "@/components/calendar/mini/Event.vue";

const props = defineProps({
  events: {
    type: Array as PropType<IEvent[]>,
    default: () => [],
  },
});

const emits = defineEmits([
  "search-event",
  "event-was-clicked",
  "day-was-clicked",
]);

const calendarSelectedDate = ref(new Date());

function onHandleDayClicked(payload: any) {
  const date = new Date(payload.dateTimeString);
  calendarSelectedDate.value = date;

  const dateTimeString = payload.dateTimeString.substring(0, 10);
  eventsOfDay.value = eventsDataProperty.value.filter((event: IEvent) => {
    const eventIsInDay = event?.time?.start.substring(0, 10) === dateTimeString;
    return eventIsInDay;
  });
  emits("day-was-clicked", payload);
}

const search = ref("");
function searchEvent() {
  emits("search-event", search.value);
}

function onHandleEventClicked(event: any) {
  emits("event-was-clicked", event);
}

const scrollbar = ref<any | null>(null);

function initScrollbar() {
  scrollbar.value = new PerfectScrollbar(".list-events", {
    wheelSpeed: 0.5,
    wheelPropagation: true,
  });
}

onMounted(() => {
  initScrollbar();
});

const eventsDataProperty = ref(props.events);
const eventsOfDay = ref(props.events);
const eventRenderingKey = ref(0);

watch(
  () => props.events,
  (newVal, oldVal) => {
    if (JSON.stringify(newVal) !== JSON.stringify(oldVal)) {
      eventsDataProperty.value = props.events;
      const dateTimeString = calendarSelectedDate.value
        .toISOString()
        .substring(0, 10);
      eventsOfDay.value = eventsDataProperty.value.filter((event: IEvent) => {
        const eventIsInDay =
          event?.time?.start.substring(0, 10) === dateTimeString;
        return eventIsInDay;
      });
      eventRenderingKey.value = eventRenderingKey.value + 1;
    }
  },
  { deep: true, immediate: true }
);
</script>

<style lang="scss">
.v-popup__content.center {
  left: auto;
}

.search-events {
  margin-top: 1rem;
  width: 100%;
  max-width: 100vw;
  height: 100%;
  min-height: 0px;
  display: flex;
  input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 0.25rem;
  }
}

.list-events {
  margin-top: 1rem;
  .list-events__item {
    width: 100%;
    margin-bottom: 0.5rem;
    cursor: pointer;
  }
  &__empty {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    p {
      font-size: 0.875rem;
      color: #ccc;
    }
  }
}

#container-list {
  height: 300px;
  overflow: auto;
  max-height: 100%;
  min-height: 0px;
  position: relative;
  .ps__rail-y {
    right: 0;
    width: 6px;
    background-color: #fff;
    opacity: 0.5;
    z-index: 1;
    .ps__thumb-y {
      background-color: $v-calendar-gray;
      border-radius: 3px;
      width: 6px;
      height: 100px;
      margin-top: 0;
      margin-bottom: 0;
    }
  }
}

.a-link {
  color: $color-primary-pure;
  font-weight: 700;
  text-decoration: none;
  cursor: pointer;
  line-height: 1rem;
  margin-left: 22%;
}
</style>
